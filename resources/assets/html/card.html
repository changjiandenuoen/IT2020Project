<div id="card1" class="Card">
	<div class="CardTop">
		<span class="CardTitle PlayerName">You</span>
		<span class="CardTitle CardNumBox"> <span class="NumOfCards">0</span> Cards</span>
	</div>
	<div class="CardFront">
		<div class="CardNameBox"><span class="CardTitle CardName">CardName</span></div>
		<img class="CardImage" src="/assets/images/characters/alt.png" onerror="this.src='/assets/images/characters/alt.png'">
		<img class="Crown" src="/assets/images/card/crown.png">
		<!-- Card category -->
		<div class="CardCategoryBox">
			<span class="CardTitle STATS">STATS</span>
			<div class="AttributeBox Attribute1">
				<span class="AttributeName Attribute">ATTRIBUTE 1</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox Attribute2">
				<span class="AttributeName Attribute">ATTRIBUTE 2</span>
				<span class="AttributeValue Attribute">0</span>
			</div>
			<div class="AttributeBox Attribute3">
				<span class="AttributeName Attribute">ATTRIBUTE 3</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute4">
				<span class="AttributeName Attribute">ATTRIBUTE 4</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute5">
				<span class="AttributeName Attribute">ATTRIBUTE 5</span>
				<span class="AttributeValue Attribute">0</span></div></div></div>
	<img class="CardBack" src="/assets/images/card/card_back.png">
</div>

<div id="card2" class="Card">
	<div class="CardTop">
		<span class="CardTitle PlayerName">Player</span>
		<span class="CardTitle CardNumBox"> <span class="NumOfCards">0</span> Cards</span>
	</div>
	<div class="CardFront">
		<div class="CardNameBox"><span class="CardTitle CardName">CardName</span></div>
		<img class="CardImage" src="/assets/images/characters/alt.png" onerror="this.src='/assets/images/characters/alt.png'">
		<img class="Crown" src="/assets/images/card/crown.png">
		<!-- Card category -->
		<div class="CardCategoryBox">
			<span class="CardTitle STATS">STATS</span>
			<div class="AttributeBox Attribute1">
				<span class="AttributeName Attribute">ATTRIBUTE 1</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox Attribute2">
				<span class="AttributeName Attribute">ATTRIBUTE 2</span>
				<span class="AttributeValue Attribute">0</span>
			</div>
			<div class="AttributeBox Attribute3">
				<span class="AttributeName Attribute">ATTRIBUTE 3</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute4">
				<span class="AttributeName Attribute">ATTRIBUTE 4</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute5">
				<span class="AttributeName Attribute">ATTRIBUTE 5</span>
				<span class="AttributeValue Attribute">0</span></div></div></div>
	<img class="CardBack" src="/assets/images/card/card_back.png">
</div>

<div id="card3" class="Card">
	<div class="CardTop">
		<span class="CardTitle PlayerName">Player</span>
		<span class="CardTitle CardNumBox"> <span class="NumOfCards">0</span> Cards</span>
	</div>
	<div class="CardFront">
		<div class="CardNameBox"><span class="CardTitle CardName">CardName</span></div>
		<img class="CardImage" src="/assets/images/characters/alt.png" onerror="this.src='/assets/images/characters/alt.png'">
		<img class="Crown" src="/assets/images/card/crown.png">
		<!-- Card category -->
		<div class="CardCategoryBox">
			<span class="CardTitle STATS">STATS</span>
			<div class="AttributeBox Attribute1">
				<span class="AttributeName Attribute">ATTRIBUTE 1</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox Attribute2">
				<span class="AttributeName Attribute">ATTRIBUTE 2</span>
				<span class="AttributeValue Attribute">0</span>
			</div>
			<div class="AttributeBox Attribute3">
				<span class="AttributeName Attribute">ATTRIBUTE 3</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute4">
				<span class="AttributeName Attribute">ATTRIBUTE 4</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute5">
				<span class="AttributeName Attribute">ATTRIBUTE 5</span>
				<span class="AttributeValue Attribute">0</span></div></div></div>
	<img class="CardBack" src="/assets/images/card/card_back.png">
</div>

<div id="deck" class="Card">
	<div class="CardTop">
		<span class="CardTitle PlayerName">Main Deck</span>
		<span class="CardTitle CardNumBox"> <span class="NumOfCards">0</span> Cards</span>
	</div>
	<div class="CardFront" style="width: 345px; height: 528px;"></div>
	<img class="CardBack" src="/assets/images/card/card_back.png">
</div>

<div id="card4" class="Card">
	<div class="CardTop">
		<span class="CardTitle PlayerName">Player</span>
		<span class="CardTitle CardNumBox"> <span class="NumOfCards">0</span> Cards</span>
	</div>
	<div class="CardFront">
		<div class="CardNameBox"><span class="CardTitle CardName">CardName</span></div>
		<img class="CardImage" src="/assets/images/characters/alt.png" onerror="this.src='/assets/images/characters/alt.png'">
		<img class="Crown" src="/assets/images/card/crown.png">
		<!-- Card category -->
		<div class="CardCategoryBox">
			<span class="CardTitle STATS">STATS</span>
			<div class="AttributeBox Attribute1">
				<span class="AttributeName Attribute">ATTRIBUTE 1</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox Attribute2">
				<span class="AttributeName Attribute">ATTRIBUTE 2</span>
				<span class="AttributeValue Attribute">0</span>
			</div>
			<div class="AttributeBox Attribute3">
				<span class="AttributeName Attribute">ATTRIBUTE 3</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute4">
				<span class="AttributeName Attribute">ATTRIBUTE 4</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute5">
				<span class="AttributeName Attribute">ATTRIBUTE 5</span>
				<span class="AttributeValue Attribute">0</span></div></div></div>
	<img class="CardBack" src="/assets/images/card/card_back.png">
</div>

<div id="card5" class="Card">
	<div class="CardTop">
		<span class="CardTitle PlayerName">Player</span>
		<span class="CardTitle CardNumBox"> <span class="NumOfCards">0</span> Cards</span>
	</div>
	<div class="CardFront">
		<div class="CardNameBox"><span class="CardTitle CardName">CardName</span></div>
		<img class="CardImage" src="/assets/images/characters/alt.png" onerror="this.src='/assets/images/characters/alt.png'">
		<img class="Crown" src="/assets/images/card/crown.png">
		<!-- Card category -->
		<div class="CardCategoryBox">
			<span class="CardTitle STATS">STATS</span>
			<div class="AttributeBox Attribute1">
				<span class="AttributeName Attribute">ATTRIBUTE 1</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox Attribute2">
				<span class="AttributeName Attribute">ATTRIBUTE 2</span>
				<span class="AttributeValue Attribute">0</span>
			</div>
			<div class="AttributeBox Attribute3">
				<span class="AttributeName Attribute">ATTRIBUTE 3</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute4">
				<span class="AttributeName Attribute">ATTRIBUTE 4</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute5">
				<span class="AttributeName Attribute">ATTRIBUTE 5</span>
				<span class="AttributeValue Attribute">0</span></div></div></div>
	<img class="CardBack" src="/assets/images/card/card_back.png">
</div>


<script>

	let fadeTime = getFadeTime();
	let fadeInDelay = getFadeInDelay();

	let cardDealt = false;

	let deck;
	let cards = [];

	let winningCard = "";
	let winner = "";
	let finalWinner = "";

	$(document).ready(function() {

		// Initilize card elements
		deck = $("#deck");
		for(let i = 0; i < getModel().numPlayers; i++) {
			cards[i] = $("#card"+(i+1));
			textFadeInOut(cards[i].find(".PlayerName"), getPlayer(i).name);
		}

		// Initilize all cards
		deck.find(".CardTop").css("opacity", 1);
		cards.forEach(function(item, index) {
			if(item != null) {
				item.find(".CardTop").css("opacity", 1);
				for(let i = 0; i < 5; i++) {
					let attrName = getCategory().attributes[i].name;
					item.find(".Attribute" + (i+1) + " .AttributeName").html(attrName);
				}
			}
		});
		updateAllCards();

		// Elements fade in
		let fadeInList = [$("#card1"), $("#card2"), $("#card3"), $("#deck"), $("#card4"), $("#card5")];
		for(let i = 0; i < fadeInList.length; i++) {
			fadeInList[i].delay(fadeInDelay+(150*i)).fadeTo(fadeTime, 1);
		}

		toggleAttrSelect();

		// Click events
		$("#card1 .CardBack").click(function() {
			flipCard(1);
			if(getStep() == 1) {
				toggleCardDraw();
				triggerContinue();
			}
		});
		$("#card1 .AttributeBox").click(function() {
			$(this).css({backgroundColor:'#cc9f3d'});
			$(this).siblings().not(":first").css({"background-color":"#e2e2e2"});

			if(getStep() == 2) {
				let str = $(this).attr("class");
				currAttrIndex = parseInt(str[str.length-1])-1;
				setCurrAttrIndex(currAttrIndex);
				toggleAttrSelect();
				triggerContinue();
			}
		});
	});


	function dealCard() {
		cardDealt = true;
		if(getRound() == 1) {
			textFadeInOut(deck.find(".PlayerName"), "Communal Pile");
			cards.forEach(function(item, index) {
				if(!getPlayer(index).dead)
					item.find(".CardBack").fadeTo(fadeTime, 1);
			});
		}

		updateMainDeck();
		updateCommunalPile();
		updatePlayers();

		updateAllCards();
		toggleCardDraw();
	}

	function cardsBattle() {
		battle();

		let json = getModel();
		if(json.winningCard) {
			winningCard = json.winningCard.name;
			let winnerIndex = json.winningCard.ownerIndex;
			winner = getPlayer(winnerIndex).name;
			let attr = "#card" + (winnerIndex+1) + " .Attribute" + (json.currAttributeIndex+1);
			$(attr).css({backgroundColor:'#cc9f3d'});
			$("#card"+(winnerIndex+1)+" .Crown").fadeIn(fadeTime);
		}

		for(let i = 2; i < getModel().numPlayers+1; i++) {
			flipCard(i);
		}
	}

	function resetAllCards() {
		$(".AttributeBox").css({backgroundColor:'#e2e2e2'});
		$(".Crown").fadeOut(fadeTime);

		updateCommunalPile();
		updatePlayers();
		
		let numCards = getCommunalPile().numCards;
		textFadeInOut(deck.find(".NumOfCards"), numCards);
		let deckBack = deck.find(".CardBack");
		if(numCards == 0)
			deckBack.fadeTo(fadeTime, 0);
		else
			deckBack.fadeTo(fadeTime, 1);

		for(let i = 0; i < getModel().numPlayers; i++) {
			if(cards[i] == null) continue;
			numCards = getPlayer(i).deck.numCards;
			textFadeInOut(cards[i].find(".NumOfCards"), numCards);
		}

		for(let i = 1; i < getModel().numPlayers+1; i++) {
			flipCard(i);
		}
	}

	function checkLosers() {
		let losers = "";
		for(let i = 0; i < getModel().numPlayers; i++) {
			if(cards[i] != null && getPlayer(i).dead) {
				cards[i].fadeTo(fadeTime, 0, function() {
					$(this).css("filter", "grayscale(100%)").fadeTo(fadeTime, 1);
				});
				cards[i] = null;
				if(losers != "") {
					losers += ", ";
				}
				losers += getPlayer(i).name;
			}
		}
		return losers;
	}

	function updateFinalWinner() {
		whoIsWinner();
		updateModel();

		let winnerIndex = getModel().winnerIndex;
		if(winnerIndex != -1) {
			finalWinner = getPlayer(winnerIndex).name;
		}
	}

	function resetRound() {
		winningCard = "";
		winner = "";

		updateModel();
		updateCommunalPile();
		updatePlayers();
	}

	function updateAllCards() {
		let deckJson;
		if(cardDealt) {
			deckJson = getCommunalPile();
		} else {
			deckJson = getMainDeck();
		}

		textFadeInOut(deck.find(".NumOfCards"), deckJson.numCards);
		let deckBack = deck.find(".CardBack");
		if(deckJson.numCards == 0)
			deckBack.fadeTo(fadeTime, 0);
		else
			deckBack.fadeTo(fadeTime, 1);

		for(let i = 0; i < getModel().numPlayers; i++) {
			let playerJson = getPlayer(i);
			let numCards = playerJson.deck.numCards;
			if(!playerJson.dead) {
				textFadeInOut(cards[i].find(".NumOfCards"), numCards);
				let name = playerJson.deck.topCard.name;
				textFadeInOut(cards[i].find(".CardName"), name);
				cards[i].find(".CardImage").attr("src", "/assets/images/characters/" + name + ".jpg");
				for(let j = 0; j < 5; j++) {
					cards[i].find(".Attribute" + (j+1) + " .AttributeValue").html(playerJson.deck.topCard.category.attributes[j].value);
				}
			}
		}
	}


	function toggleCardDraw() {
		let card = cards[0].find(".CardBack");
		if(card.css("cursor") == "pointer") {
			card.css({
				"cursor": "default",
				"pointer-events": "none"
			});
		} else {
			card.css({
				"cursor": "pointer",
				"pointer-events": "auto"
			});
		}
	}

	function toggleAttrSelect() {
		$("#card1 .AttributeBox").each(function(index) {
			if($(this).css("cursor") == "pointer") {
				$(this).css({
					"cursor": "default",
					"pointer-events": "none"
				});
			} else {
				$(this).css({
					"cursor": "pointer",
					"pointer-events": "auto"
				});
			}
		});
	}

	function flipCard(index) {
		let card;
		if(index == 0) {
			card = deck;
		} else card = cards[index-1];

		if(card == null) return;

		let cardFront = card.find(".CardFront");
		let cardBack = card.find(".CardBack");

		if(cardBack.css("display") == "none") {
			cardFront.fadeOut(fadeTime, function() { cardBack.fadeTo(fadeTime, 1); });
		} else {
			cardBack.fadeOut(fadeTime, function() { cardFront.fadeTo(fadeTime, 1); });
		}
	}


	function getWinningCard() {
		return winningCard;
	}
	function getWinner() {
		return winner;
	}
	function getFinalWinner() {
		return finalWinner;
	}

</script>
