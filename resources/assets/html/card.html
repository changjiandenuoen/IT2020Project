<div id="card1" class="Card">
	<div class="CardTop">
		<span class="CardTitle PlayerName">You</span>
		<span class="CardTitle CardNumBox"> <span class="NumOfCards">0</span> Cards</span>
	</div>
	<div class="CardFront">
		<div class="CardNameBox"><span class="CardTitle CardName">CardName</span></div>
		<img class="CardImage" src="/assets/images/characters/alt.png" onerror="this.src='/assets/images/characters/alt.png'">
		<!-- Card category -->
		<div class="CardCategoryBox">
			<span class="CardTitle STATS">STATS</span>
			<div class="AttributeBox Attribute1">
				<span class="AttributeName Attribute">ATTRIBUTE 1</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox Attribute2">
				<span class="AttributeName Attribute">ATTRIBUTE 2</span>
				<span class="AttributeValue Attribute">0</span>
			</div>
			<div class="AttributeBox Attribute3">
				<span class="AttributeName Attribute">ATTRIBUTE 3</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute4">
				<span class="AttributeName Attribute">ATTRIBUTE 4</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute5">
				<span class="AttributeName Attribute">ATTRIBUTE 5</span>
				<span class="AttributeValue Attribute">0</span></div></div></div>
	<img class="CardBackBase" src="/assets/images/card/card_back.png" onerror="this.src='/assets/images/characters/alt.png'">
	<img class="CardBack" src="/assets/images/card/card_back.png" onerror="this.src='/assets/images/characters/alt.png'">
</div>

<div id="card2" class="Card">
	<div class="CardTop">
		<span class="CardTitle PlayerName">Player</span>
		<span class="CardTitle CardNumBox"> <span class="NumOfCards">0</span> Cards</span>
	</div>
	<div class="CardFront">
		<div class="CardNameBox"><span class="CardTitle CardName">CardName</span></div>
		<img class="CardImage" src="/assets/images/characters/alt.png" onerror="this.src='/assets/images/characters/alt.png'">
		<!-- Card category -->
		<div class="CardCategoryBox">
			<span class="CardTitle STATS">STATS</span>
			<div class="AttributeBox Attribute1">
				<span class="AttributeName Attribute">ATTRIBUTE 1</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox Attribute2">
				<span class="AttributeName Attribute">ATTRIBUTE 2</span>
				<span class="AttributeValue Attribute">0</span>
			</div>
			<div class="AttributeBox Attribute3">
				<span class="AttributeName Attribute">ATTRIBUTE 3</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute4">
				<span class="AttributeName Attribute">ATTRIBUTE 4</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute5">
				<span class="AttributeName Attribute">ATTRIBUTE 5</span>
				<span class="AttributeValue Attribute">0</span></div></div></div>
	<img class="CardBackBase" src="/assets/images/card/card_back.png" onerror="this.src='/assets/images/characters/alt.png'">
	<img class="CardBack" src="/assets/images/card/card_back.png" onerror="this.src='/assets/images/characters/alt.png'">
</div>

<div id="card3" class="Card">
	<div class="CardTop">
		<span class="CardTitle PlayerName">Player</span>
		<span class="CardTitle CardNumBox"> <span class="NumOfCards">0</span> Cards</span>
	</div>
	<div class="CardFront">
		<div class="CardNameBox"><span class="CardTitle CardName">CardName</span></div>
		<img class="CardImage" src="/assets/images/characters/alt.png" onerror="this.src='/assets/images/characters/alt.png'">
		<!-- Card category -->
		<div class="CardCategoryBox">
			<span class="CardTitle STATS">STATS</span>
			<div class="AttributeBox Attribute1">
				<span class="AttributeName Attribute">ATTRIBUTE 1</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox Attribute2">
				<span class="AttributeName Attribute">ATTRIBUTE 2</span>
				<span class="AttributeValue Attribute">0</span>
			</div>
			<div class="AttributeBox Attribute3">
				<span class="AttributeName Attribute">ATTRIBUTE 3</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute4">
				<span class="AttributeName Attribute">ATTRIBUTE 4</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute5">
				<span class="AttributeName Attribute">ATTRIBUTE 5</span>
				<span class="AttributeValue Attribute">0</span></div></div></div>
	<img class="CardBackBase" src="/assets/images/card/card_back.png" onerror="this.src='/assets/images/characters/alt.png'">
	<img class="CardBack" src="/assets/images/card/card_back.png" onerror="this.src='/assets/images/characters/alt.png'">
</div>

<div id="deck" class="Card">
	<div class="CardTop">
		<span class="CardTitle PlayerName">Main Deck</span>
		<span class="CardTitle CardNumBox"> <span class="NumOfCards">0</span> Cards</span>
	</div>
	<div class="CardFront">
		<div class="CardNameBox"><span class="CardTitle CardName">CardName</span></div>
		<img class="CardImage" src="/assets/images/characters/alt.png" onerror="this.src='/assets/images/characters/alt.png'">
		<!-- Card category -->
		<div class="CardCategoryBox">
			<span class="CardTitle STATS">STATS</span>
			<div class="AttributeBox Attribute1">
				<span class="AttributeName Attribute">ATTRIBUTE 1</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox Attribute2">
				<span class="AttributeName Attribute">ATTRIBUTE 2</span>
				<span class="AttributeValue Attribute">0</span>
			</div>
			<div class="AttributeBox Attribute3">
				<span class="AttributeName Attribute">ATTRIBUTE 3</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute4">
				<span class="AttributeName Attribute">ATTRIBUTE 4</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute5">
				<span class="AttributeName Attribute">ATTRIBUTE 5</span>
				<span class="AttributeValue Attribute">0</span></div></div></div>
	<img class="CardBackBase" src="/assets/images/card/card_back.png" onerror="this.src='/assets/images/characters/alt.png'">
	<img class="CardBack" src="/assets/images/card/card_back.png" onerror="this.src='/assets/images/characters/alt.png'">
</div>

<div id="card4" class="Card">
	<div class="CardTop">
		<span class="CardTitle PlayerName">Player</span>
		<span class="CardTitle CardNumBox"> <span class="NumOfCards">0</span> Cards</span>
	</div>
	<div class="CardFront">
		<div class="CardNameBox"><span class="CardTitle CardName">CardName</span></div>
		<img class="CardImage" src="/assets/images/characters/alt.png" onerror="this.src='/assets/images/characters/alt.png'">
		<!-- Card category -->
		<div class="CardCategoryBox">
			<span class="CardTitle STATS">STATS</span>
			<div class="AttributeBox Attribute1">
				<span class="AttributeName Attribute">ATTRIBUTE 1</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox Attribute2">
				<span class="AttributeName Attribute">ATTRIBUTE 2</span>
				<span class="AttributeValue Attribute">0</span>
			</div>
			<div class="AttributeBox Attribute3">
				<span class="AttributeName Attribute">ATTRIBUTE 3</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute4">
				<span class="AttributeName Attribute">ATTRIBUTE 4</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute5">
				<span class="AttributeName Attribute">ATTRIBUTE 5</span>
				<span class="AttributeValue Attribute">0</span></div></div></div>
	<img class="CardBackBase" src="/assets/images/card/card_back.png" onerror="this.src='/assets/images/characters/alt.png'">
	<img class="CardBack" src="/assets/images/card/card_back.png" onerror="this.src='/assets/images/characters/alt.png'">
</div>

<div id="card5" class="Card">
	<div class="CardTop">
		<span class="CardTitle PlayerName">Player</span>
		<span class="CardTitle CardNumBox"> <span class="NumOfCards">0</span> Cards</span>
	</div>
	<div class="CardFront">
		<div class="CardNameBox"><span class="CardTitle CardName">CardName</span></div>
		<img class="CardImage" src="/assets/images/characters/alt.png" onerror="this.src='/assets/images/characters/alt.png'">
		<!-- Card category -->
		<div class="CardCategoryBox">
			<span class="CardTitle STATS">STATS</span>
			<div class="AttributeBox Attribute1">
				<span class="AttributeName Attribute">ATTRIBUTE 1</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox Attribute2">
				<span class="AttributeName Attribute">ATTRIBUTE 2</span>
				<span class="AttributeValue Attribute">0</span>
			</div>
			<div class="AttributeBox Attribute3">
				<span class="AttributeName Attribute">ATTRIBUTE 3</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute4">
				<span class="AttributeName Attribute">ATTRIBUTE 4</span>
				<span class="AttributeValue Attribute">0</span></div>
			<div class="AttributeBox  Attribute5">
				<span class="AttributeName Attribute">ATTRIBUTE 5</span>
				<span class="AttributeValue Attribute">0</span></div></div></div>
	<img class="CardBackBase" src="/assets/images/card/card_back.png" onerror="this.src='/assets/images/characters/alt.png'">
	<img class="CardBack" src="/assets/images/card/card_back.png" onerror="this.src='/assets/images/characters/alt.png'">
</div>


<script>

	let numPlayers = -1;
	let currAttrIndex = -1;
	let cardDealt = false;
	let fadeInDelay = 700;

	let deck = $("#deck");
	let cards = [$("#deck"), $("#card1"), $("#card2"), $("#card3"), $("#card4"), $("#card5")];
	let numCardList = [];
	let playerNames = ["You", "AI Player 1", "AI Player 2", "AI Player 3", "AI Player 4"];
	let attrNames = [];

	let yourCard = "";
	let winningCard = "";
	let winner = "";
	let hostName = "";

	$(document).ready(function() {

		let fadeInList = [$("#card1"), $("#card2"), $("#card3"), $("#deck"), $("#card4"), $("#card5")];
		for(let i = 0; i < fadeInList.length; i++) {
			fadeInList[i].delay(fadeInDelay+(150*i)).fadeTo(700, 1);
		}

		for(let i = 2; i < 6; i++) {
			cards[i].find(".PlayerName").html(playerNames[i-1]);
		}

		let xhr = createCORSRequest('GET', "/toptrumps/model");
		xhr.onload = function(e) {
			let json = JSON.parse(xhr.responseText);
			numPlayers = json.numPlayers;
			for(let i = 0; i < numPlayers+1; i++) {
				cards[i].find(".CardTop").css("opacity", 1);
				for(let j = 0; j < 5; j++) {
					let attrName = json.category.attributes[j].name;
					cards[i].find(".Attribute" + (j+1) + " .AttributeName").html(attrName);
					attrNames[j] = attrName;
				}
			}
		};
		xhr.send();

		updateCardNum();
		toggleAttrSelect();
		deck.find(".CardBack").fadeTo(600, 1);

		$("#card1 .CardBack").click(function() {
			flipCard(0);
			if(getStep() == 1) {
				toggleCardDraw();
				triggerContinue();
			}
		});

		$("#card1 .AttributeBox").click(function(event) {
			$(this).css({backgroundColor:'#cc9f3d'});
			$(this).siblings().css({"background-color":"#e2e2e2"});

			if(getStep() == 2) {
				currAttrIndex = $(this).find(".CardName").html();
				toggleAttrSelect();
				triggerContinue();
			}
        });

	});

	function dealCard(playerIndex) {
		cardDealt = true;

		deck.find(".PlayerName").fadeTo(800, 0, function() {
			$(this).html("Communal Pile").fadeTo(800, 1);
		});

		deck.find(".CardBack").fadeTo(800, 0, function() {
			for(let i = 0; i < numPlayers; i++) {
				let card = cards[i+1];
				card.find(".CardBack").fadeTo(800, 1);
			}

			updateCardNum();
			
			if(numCardList[0] != 0) {
				$(this).fadeTo(800, 1);
			}
		});

		getTopCard(0);
		toggleCardDraw();
	}

	function selectAttribute() {
		if(hostName == "You") {
			toggleAttrSelect();
		} else {
			
		}
	}


	function toggleCardDraw() {
		let card = cards[1].find(".CardBack");
		if(card.css("cursor") == "pointer") {
			card.css({
				"cursor": "default",
				"pointer-events": "none"
			});
		} else {
			card.css({
				"cursor": "pointer",
				"pointer-events": "auto"
			});
		}
	}

	function toggleAttrSelect() {
		for(let i = 1; i < 6; i++) {
			let attrBox = cards[1].find(".Attribute"+i);
			if(attrBox.css("cursor") == "pointer") {
				attrBox.css({
					"cursor": "default",
					"pointer-events": "none"
				});
			} else {
				attrBox.css({
					"cursor": "pointer",
					"pointer-events": "auto"
				});
			}
		}
	}

	function flipCard(playerIndex) {

		let card = cards[playerIndex+1];

		let cardFront = card.find(".CardFront");
		let cardBack = card.find(".CardBack");

		if(cardBack.css("display") == "none") {
			cardFront.fadeOut(600, function() { cardBack.fadeTo(600, 1); });
		} else {
			cardBack.fadeOut(600, function() { cardFront.fadeTo(600, 1); });
		}
	}

	function getTopCard(playerIndex) {

		let xhr = createCORSRequest('GET', "/toptrumps/deck?Owner="+playerIndex);
		xhr.onload = function(e) {
			let json = JSON.parse(xhr.responseText);

			if(json.topCard == null) return;

			name = json.topCard.name;

			if(playerIndex == 0) {
				yourCard = name;
			}

			let card;
			if(playerIndex == -1) {
				card = deck;
			} else if(playerIndex < 5) {
				card = $("#card"+(playerIndex+1));
			}

			card.find(".CardName").html(name);
			card.find(".CardImage").attr("src", "/assets/images/characters/" + name + ".jpg");
			for(let i = 0; i < 5; i++) {
				card.find(".Attribute" + (i+1) + " .AttributeValue").html(json.topCard.category.attributes[i].value);
			}
		};
		xhr.send();
		
		return name;
	}

	function updateCardNum() {
		if(numPlayers == -1) {
			console.log("Number of players not initialized!");
			return;
		}

		for(let i = 0; i < numPlayers+1; i++) {
			let index = i - 1;
			if(i == 0 && cardDealt) {
				index = -2;
			}
			let xhr = createCORSRequest('GET', "/toptrumps/deck?Owner="+index);
			xhr.onload = function(e) {
				let json = JSON.parse(xhr.responseText);
				let numCards = json.numCards;
				cards[i].find(".NumOfCards").html(numCards);
				numCardList[i] = numCards;
			};
			xhr.send();
		}
	}

	function dealCardAnimation() {
		// let x ,y;
		// let playerCard = $("#card"+(playerIndex+1)).find(".CardFront");

		// x = playerCard.offset().left;
		// y = playerCard.offset().top;

		// cardBack.animate({
		// 	left: 100000,
		// }, 1000);
	}

	function getYourCard() {
		return yourCard;
	}
	function getHostName() {
		return hostName;
	}
	function setHostName(name) {
		hostName = name;
	}
	function getCurrAttrName() {
		return attrNames[currAttrIndex];
	}
	function getWinnerCard() {
		return winningCard;
	}
	function getWinner() {
		return winner;
	}
	function getPlayerName(playerIndex) {
		return playerNames[playerIndex];
	}

</script>
